<!doctype html>

<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Required meta tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Tableau de bord sessions</title>

  <link rel="stylesheet" href="bootstrap-sncf.metier.v4.3.1-r5/bootstrap-sncf.min.css">
  <link rel="stylesheet alternate" href="bootstrap-sncf.metier.v4.3.1-r5/bootstrap-sncf.darkmode.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" type="text/css" href="jquery.dataTables.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.6.5/css/buttons.dataTables.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/searchpanes/1.2.1/css/searchPanes.dataTables.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.3.1/css/select.dataTables.min.css">

</head>

<body class="d-flex flex-column">
    <div id="includedContentAgo5"></div>

        <div class="container-fluid flex-grow-1 flex-shrink-0">
      <h1 class="text-center mb-5"> Tableau de bord sessions </h1>

      <div class="row">
        <div class="col-md-12 row">

            <div class="col-md-2">
              <label for="dateDebut" class="ml-1"> Date de début (jj/mm/aaaa) </label>
                <div data-component="picker">
                    <div class="input-group" data-toggle>
                      <div class="form-control-container">
                        <input id="dateDebut" type="text" class="form-control whiteinput" placeholder="Date début" data-input>
                        <span class="form-control-state"></span>
                      </div>
                      <div class="input-group-append">
                        <button type="button" class="btn btn-primary btn-only-icon" data-role="btn" tabindex="-1" aria-expanded="false">
                          <i class="icons-calendar" aria-hidden="true"></i>
                        </button>
                      </div>
                    </div>
                </div>
            </div>

            <div class="col-md-2">
              <label for="dateFin" class="ml-1"> Date de fin (jj/mm/aaaa) </label>
                  <div data-component="picker">
                      <div class="input-group" data-toggle>
                        <div class="form-control-container">
                          <input id="dateFin" type="text" class="form-control whiteinput" placeholder="Date de fin" data-input>
                          <span class="form-control-state"></span>
                        </div>
                        <div class="input-group-append">
                          <button type="button" class="btn btn-primary btn-only-icon" data-role="btn" tabindex="-1" aria-expanded="false">
                            <i class="icons-calendar" aria-hidden="true"></i>
                          </button>
                        </div>
                      </div>
                  </div>
            </div>

            <div class="col-md-1">
              <button class="btn btn-success btn-block btnvalid"> Valider </button>
            </div>
            
            <div class="col-md-2 offset-md-5">
              <button onclick="showGraph()" class="btn btn-primary mb-3 btnvalid"> Afficher graphiques</button>
            </div>
        </div>
        <div class="col-md-12" id="graph">
          <div class="row">
            <div class="col-md-5 offset-md-1">
              <div id="container" style="width:90%; height:100%"> </div>
            </div>
            <div class="col-md-5">
              <div id="container2" style="width:90%; height:100%"> </div>
            </div>
            <div class="col-md-4 offset-md-4 mt-3 h-10">
                <div id="container3" style="width:90%; height:70%"> </div>
            </div>
          </div>
        </div>
        <div class="col-md-12 mt-5">
          <table class="table display" id="cofoall">
            <thead class="thead bg-secondary text-white">
              <tr>
                  <th scope="col"> Code RAF</th>
                  <th scope="col"> Libellé de l'action </th>
                  <th scope="col"> Code Session </th>
                  <th scope="col"> Lieu </th>
                  <th scope="col"> Date de début </th>
                  <th scope="col"> Date de fin </th>
                  <th scope="col"> Division métier</th>
                  <th scope="col"> Groupe </th>
                  <th scope="col"> Typologie</th>
                  <th scope="col"> Théorique</th>
                  <th scope="col"> Inscrits</th>
              </tr>
            </thead>
            <tbody class="tbody">
              
              <tr>
                <td> VE200200</td>
                <td> Protections MICOM P12x</td>
                <td> NVE0000047</td>
                <td> Nanterre</td>
                <td> 02/06/2021</td>
                <td> 03/06/2021</td>
                <td> Caténaire</td>
                <td> Continue</td>
                <td> Continue</td>
                <td> 12 </td>
                <td> 11 </td>
              </tr>

              <tr>
                <td> VE200200</td>
                <td> Protections MICOM P12x</td>
                <td> NVE0000053</td>
                <td> Nanterre</td>
                <td> 23/06/2021</td>
                <td> 24/06/2021</td>
                <td> Caténaire</td>
                <td> Continue</td>
                <td> Continue</td>
                <td> 12 </td>
                <td> 10 </td>
              </tr>

              
             
              <tr>
                <td> VSC10500TS</td>
                <td> Agent desserte, chef de la manoeuvre Convoi du GI TS</td>
                <td> NVS0000369</td>
                <td> Nanterre</td>
                <td> 14/06/2021</td>
                <td> 25/06/2021</td>
                <td> Produit Train</td>
                <td> Continue</td>
                <td> Continue</td>
                <td> 16 </td>
                <td> 13 </td>
              </tr>
            
              <tr>
                <td> VVI12000TS </td>
                <td> Agent PN en travaux TS</td>
                <td> NVV0000751</td>
                <td> Nanterre</td>
                <td> 15/06/2021</td>
                <td> 16/06/2021</td>
                <td> Voie</td>
                <td> Continue</td>
                <td> Initiale</td>
                <td> 8 </td>
                <td> 6 </td>
              </tr>

              <tr>
                <td> VVI12000TS </td>
                <td> Agent PN en travaux TS</td>
                <td> NVV0000861</td>
                <td> Nanterre</td>
                <td> 26/06/2021</td>
                <td> 27/06/2021</td>
                <td> Voie</td>
                <td> Continue</td>
                <td> Initiale</td>
                <td> 8 </td>
                <td> 7 </td>
              </tr>
              
              <tr>
                <td> VVTESC03  </td>
                <td> TES C - Avec TTx</td>
                <td> NVV0000034</td>
                <td> Nanterre</td>
                <td> 21/06/2021</td>
                <td> 30/06/2021</td>
                <td> Voie</td>
                <td> Continue</td>
                <td> Continue</td>
                <td> 16 </td>
                <td> 15 </td>
              </tr>

              <tr>
                <td> VT160000  </td>
                <td> Réseaux IP et applicatifs SNCF</td>
                <td> NVT000146</td>
                <td> Nanterre</td>
                <td> 21/06/2021</td>
                <td> 25/06/2021</td>
                <td> Signalisation</td>
                <td> Continue</td>
                <td> Continue</td>
                <td> 12 </td>
                <td> 10 </td>
              </tr>

              <tr>
                <td> VT160000  </td>
                <td> Réseaux IP et applicatifs SNCF</td>
                <td> NVT000185</td>
                <td> Nanterre</td>
                <td> 07/06/2021</td>
                <td> 11/06/2021</td>
                <td> Signalisation</td>
                <td> Continue</td>
                <td> Continue</td>
                <td> 12 </td>
                <td> 7 </td>
              </tr>
             
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div id="footerago5"></div>
    <script src="bootstrap-sncf.metier.v4.3.1-r5/bootstrap-sncf.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.23/js/jquery.dataTables.min.js" ></script>
    <script src="https://cdn.datatables.net/buttons/1.6.5/js/dataTables.buttons.min.js" ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js" ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js" ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js" ></script>
    <script src="https://cdn.datatables.net/buttons/1.6.5/js/buttons.html5.min.js" ></script>
    <script src="https://cdn.datatables.net/searchpanes/1.2.1/js/dataTables.searchPanes.min.js"></script>
    <script src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/modules/solid-gauge.js"></script>
    <script src="https://code.highcharts.com/modules/series-label.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="script.js"></script>

    <script>
       $(function(){
        $("#includedContentAgo5").load("navago.html"); 
        $("#footerago5").load("footer.html"); 
      });

      $(document).ready(function() {
      var table = $('#cofoall').DataTable({
        dom: 'BPfrtip',
        "pagingType": "full_numbers",
        "initComplete": function() {
          $('.dataTables_filter input').addClass('form-control');
        },
        columnDefs:[
            {
                searchPanes:{
                    show: true, // It can be true/false
                },
                targets: [0,2,3,4,5,6,7], // Index of columns (starting at 0) that you want show/hide                
            },
            { width: "30%", targets: 1 },
            {
      orderable: false,
      targets: "no-sort"
    }
        ],
        lengthMenu: [
          [10, 25, 50, 100],
          [ '10 ', '25 ', '50 ', '100 ']
        ],
        buttons: [
          //'searchPanes',
            {
              extend : 'pageLength',
              className : 'btn btn-success mt-1',
              
            },
            {
              text: 'Filtres avancés',
              className: 'btn btn-primary',
              action: function (e, dt, node, config) {
                  $(".dtsp-panesContainer").toggle()
              },
              init: function( api, node, config) {
                  $(node).removeClass('dt-button')
              }
            },
            {
              extend : 'copyHtml5',
              text : 'Copier',
              copyTitle: 'Données copiées',
              className : 'btn btn-warning',
              exportOptions: {
                columns: [ 0,1,2,3,4,5,6,7,8]
                },
                init: function( api, node, config) {
                  $(node).removeClass('dt-button buttons-copy buttons-html5')
              }
            },
            {
              extend : 'excelHtml5',
              className : 'btn btn-success',
              title : 'Export sessions du '+titleFile(),
              filename : function() {
                  return "Export_Sessions_"+dateFile()
              },
              exportOptions: {
                columns: [ 0,1,2,3,4,5,6,7,8]
                },
                init: function( api, node, config) {
                  $(node).removeClass('dt-button buttons-excel buttons-html5')
              }
            },
            {
              extend : 'csvHtml5',
              className : 'btn btn-success',
              filename : function() {
                  return "Export_Sessions_"+dateFile()
              },
              exportOptions: {
                columns: [ 0,1,2,3,4,5,6,7,8]
                },
                init: function( api, node, config) {
                  $(node).removeClass('dt-button buttons-csv buttons-html5')
                }

            },
            {
                extend: 'pdfHtml5',
                orientation: 'landscape',
                pageSize : 'LEGAL',
                title : 'Export sessions du '+titleFile(),
                filename : function() {
                    return "Export_Sessions_"+dateFile()
                },
                exportOptions: {
                  columns: [ 0,1,2,3,4,5,6,7,8]
                },
                customize: function (doc) {
                  doc.content[1].table.widths = 
                      Array(doc.content[1].table.body[0].length + 1).join('*').split('');
                  doc.styles.tableBodyEven.alignment = 'center';
                  doc.styles.tableBodyOdd.alignment = 'center'; 
                },
                className : 'btn btn-primary',
                init: function( api, node, config) {
                  $(node).removeClass('dt-button buttons-pdf buttons-html5')
                }
            }
        ],
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.22/i18n/French.json",
            searchPanes: {
                collapse: "Afficher les filtres",
                title : {
                  _: '%d - Filtres sélectionnés',
                  0 : 'Aucun filtres sélectionnés'
                },
                clearMessage : 'Réinitialisé'
            },
            buttons : {
              pageLength: {
                _: "%d éléments par page",
                '-1': "Tout afficher"
              },
              copy: 'Copier',
            copySuccess: {
                1: "Copie d'une ligne",
                _: "Copie de %d lignes"
            },
            copyTitle: 'Données copiées',
            copyKeys: 'Press <i>ctrl</i> or <i>\u2318</i> + <i>C</i> to copy the table data<br>to your system clipboard.<br><br>To cancel, click this message or press escape.'

            ,
       
            },
        }
      });
      $('#cofoall thead th').addClass('text-white');
      var chart = Highcharts.chart('container', {
          chart: {
              type: 'pie',
          },
          title: {
              text: 'Code RAF',
          },
          tooltip: {
            pointFormat: 'Nombre de session(s) {point.y}'
          },
          plotOptions: {
            pie: {
              dataLabels: {
                enabled: true,
                format: '<b>{point.y} session(s) {point.name}',
              }
            }
          },
          series: [
              {
                  data: chartData(table,0),
              },
          ],
      });

      var chart2 = Highcharts.chart('container2', {
          chart: {
            type: 'column'
          },
          title: {
              text: 'Taux de remplissage par code RAF',
          },
          xAxis: {
            type: 'category',
            labels: {
                rotation: -45,
                style: {
                    fontSize: '10px',
                    fontFamily: 'Verdana, sans-serif'
                }
            }
          },
          tooltip: {
            pointFormat: 'Taux de remplissage {point.y}%'
          },
          plotOptions: {
            pie: {
              dataLabels: {
                enabled: true,
                format: '<b>{point.name}: {point.y}%',
              }
            }
          },
          series: [
              {
                  data: tauxremplissage(table),
                  colorByPoint: true,
                  /*
                  dataLabels: {
                    enabled: true,
                    color: '#FFFFFF',
                    align: 'right',
                    rotation: -90,
                    format: '{point.y:.1f} %', // one decimal
                    y: 30, // 10 pixels down from the top
                    style: {
                        fontSize: '8px',
                        fontFamily: 'Verdana, sans-serif'
                    }
                  }
                  */
              },
          ],
      });

      var chart3 = Highcharts.chart('container3', {
        chart: {
          type: 'solidgauge',
          height: 280,
        },

        title: {
              text: "Taux de remplissage de l'ensemble des sessions",
        },

        pane: {
            size: '100%',
            startAngle: -90,
            endAngle: 90,
            background: {
                backgroundColor:
                    Highcharts.defaultOptions.legend.backgroundColor || '#EEE',
                innerRadius: '60%',
                outerRadius: '100%',
                shape: 'arc'
            }
        },
        // the value axis
        yAxis: {
            stops: [
              [0.1, 'red'], // green
              [0.7, 'red'], // yellow
              [0.99, 'green'] // red
            ],
            lineWidth: 0,
            tickWidth: 0,
            minorTickInterval: null,
            tickAmount: 2,
            labels: {
                y: 16
            },
           min: 0,
          max: 100,
        },

        plotOptions: {
            solidgauge: {
                dataLabels: {
                    y: 5,
                    borderWidth: 0,
                    useHTML: true
                }
            }
        },
        series: [{
        name: 'Taux de remplissage',
        data: tauxremplissageglobal(table),
        dataLabels: {
            format:
                '<div style="text-align:center">' +
                '<span style="font-size:25px">{y}%</span><br/>' +
                '</div>'
        },
    }]

      });

    // On each draw, update the data in the chart
    table.on('draw', function () {
        chart.series[0].setData(chartData(table,0));
        chart.series[0].setName("Total");
        chart2.series[0].setData(tauxremplissage(table));
        chart2.series[0].setName("Taux de remplissage")
        chart3.series[0].setData(tauxremplissageglobal(table));
        chart3.series[0].setName("Taux de remplissage");     
      });
    })

    function chartData(table,column) {
      var counts = {};
  
      // Count the number of entries for each position
      table
          .column(column, { search: 'applied' })
          .data()
          .each(function (val) {
              if (counts[val]) {
                  counts[val] += 1;
              } else {
                  counts[val] = 1;
              }
          });

      // And map it to the format highcharts uses
      return $.map(counts, function (val, key) {
          return {
              name: key,
              y: val,
          };
      });
    }


    function tauxremplissage(table) {
      var counts = {};
      var res = {};
      // Count the number of entries for each position
      table.rows({ search: 'applied' }).every(function(){
        var row = this.data()
        var val = row[0]
        if (res[val]) {
          res[val][0] += parseInt(row[9])
          res[val][1] += parseInt(row[10])
        } else {
          res[val] = [parseInt(row[9]),parseInt(row[10])]
        }
      })
      var total1=0
      var total2=0
      for (const [key, value] of Object.entries(res)) {
        var num = res[key][1] / res[key][0] * 100
        total1 += res[key][1]
        total2+= res[key][0]
        counts[key] = parseFloat(num.toFixed(2))
      }
      var numtotal = total1 / total2 * 100
      if(isNaN(numtotal))
        numtotal=0
      var tauxtotal = parseFloat(numtotal.toFixed(2))
      $("#taux").text(tauxtotal + "%")
      // And map it to the format highcharts uses
      return $.map(counts, function (val, key) {
          return {
              name: key,
              y: val,
          };
      });
    }

    function tauxremplissageglobal(table) {
      var counts = {};
      var res = {};
      // Count the number of entries for each position
      table.rows({ search: 'applied' }).every(function(){
        var row = this.data()
        var val = row[0]
        if (res[val]) {
          res[val][0] += parseInt(row[9])
          res[val][1] += parseInt(row[10])
        } else {
          res[val] = [parseInt(row[9]),parseInt(row[10])]
        }
      })
      var total1=0
      var total2=0
      for (const [key, value] of Object.entries(res)) {
        var num = res[key][1] / res[key][0] * 100
        total1 += res[key][1]
        total2+= res[key][0]
        counts[key] = parseFloat(num.toFixed(2))
      }
      var numtotal = total1 / total2 * 100
      if(isNaN(numtotal))
        numtotal=0
      var tauxtotal = parseFloat(numtotal.toFixed(2))
      var resarray = []
      resarray.push(tauxtotal)
      return resarray
    }

    

function showGraph() {
  $("#graph").toggle()
}

    </script>
</body>
</html>